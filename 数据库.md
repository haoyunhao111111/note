

# 数据库

> 关系型数据库(MySQL)          非关系型数据库(redis)          数据仓库

## DCL:数据控制语言   

> (Database Controll Language)数据控制语言

### 访问控制权限

> MySQL实现了复杂的访问控制和权限系统，允许你创建的

### 命令行链接方式

```mysql
mysql -u 用户名 -p 密码 -h 服务器IP地址 -P服务器端MySQL端口号  -D 数据库名
```

### 默认表

> mysql安装程序自动创建一个名为mysql的数据库

- user：包含用户账号和全局权限列
- db:用户对于数据库的访问权限
- table_priv和columns_priv:表级和列级权限
- procs_priv:包含储存函数

### 创建账户：

```mysql
create user user_account IDENTIFIED  by password;

create user 'hyh'@'localhost' identified by '123123';
```

user_account---->username@hostname



### 通配符%

> 指定域名下任何地址都可以访问到

```mysql
create user username@'%.alibaba.com' identified by password;

create user 'hyh'@'%.alibaba.com' identified by '123123';
```



### 省略主机名

```mysql
create user 'hyh1' identified by '123123';
```



### 删除账户

```mysql
drop user username@hostname,[username]
drop user 'hyh'@'localhost';
```



### 查看用户权限

```mysql
show grants for username@hastname

show grants for 'hyh'@'localhost';
```



### 设置权限

```mysql
grant privilege all on privilege_level(作用于表)
to user 'username'@hostname  
[require tsl_option]  (链接方式)
[with [grant_option | resource_option]]  （是否允许其他用户更改权限）
```



### 允许远程链接

```mysql
grant all privileges on *.* to 'root'@'%' identified by 'mysql' with grant opion;
flush privileges;（刷新）
```



### 撤销权限（revoke）

```mysql
revoke privilege_type 权限
on 表
from user 
```



### 修改密码

- 首先登陆mysql

```mysql
set password for username@localhost =password('新密码')
```

- update编辑user

```mysql
update user set password=password("123") where user='root'
```



- 用mysqladmin

```mysql
mysqladmin -u用户名 -p旧密码 password 新密码
```

- 忘记root密码或初始化密码(以window为例)

  - 关闭正在运行的mysql服务器
  - 打开DOS窗口，转到mysql/bin目录
  - 输入

  ```mysql
  mysqld --skip-grant-tables
  ```

  - 再开一个DOS窗口
  - 输入mysql回车
  - 连接权限数据库：use mysql
  - 改密码
  - 刷新权限
  - 退出
  - 注销系统

### 数据库备份

#### mysqldump命令

```python
mysqldump -u[username] -p[password] [datebase_name] > [dump_file.sql]
```

- username:有效的mysql用户名
- password：密码
- datebase_name：要备份的数据库名称
- dump_file.sql:要生成的备份文件

#### 仅备份数据库结构

```mysql
mysqldump -u[username] -p[password] --no-date [datebase_name] > [dump_file.sql]
```

#### 仅备份数据库数据

```mysql
mysqldump -u[username] -p[password] --no-create-info [datebase_name] > [dump_file.sql]
```

#### 导出多个数据库

```mysql
mysqldump -u[username] -p[password] --all-datebase > [dump_file.sql]
```

### 查看列

```mysql
show columns from teacher;  查看某个表的列
show columns from teacher like field;  查看某一表的某一列
show columns from teacher where field='name' 查看某一表的某一列
```

### 查询用户信息

- 所有用户

```mysql
select user from user;
```

- 当前用户

```mysql
select user();
```

- 当前登录的用户

```mysql
select user,host,db,command from information_schema.processlist;
```



### 数据库维护

> 数据库提供了几个语句，可以有效的维护数据库表

#### 分析表语句

```mysql
analyze table 表名
```

#### 优化表语句

```mysql
optimize table 表名
```

#### 检查表语句

```mysql
check table 表名
```

#### 修复表语句(尝试)

```mysql
repair table 表名
```



## DDL:数据库定义语言 

> （Data Definition Language）数据库定义语言

### 创建数据库

```mysql
create database [if not exists] database_name
```

### 删除数据库

```mysql
drop database [if not exists] database_name
```

### 创建表

```mysql
create table if not exists table_name(
	column_list
)engine=table_type;
```

### 语法实例

```mysql
create table stu (
    id int(10) not null auto_increment primary key,   #表头名 数据类型 不为空 自增  主键
    name  varchar(10) null unique,  #default  索引
    age varchar(10),
    sex enum('0','1'),  #枚举类型
)default charset=utf8 engine=InnoDB;    #指定字符编码类型
```

### 修改表

```mysql
alter table demo change column name name1 varchar(100) not null;  #修改列
alter table demo add pass varchar(32) not null [first | after exists_column];   #增加列
alter table drop cloumn_name;  #删除列
alter table table_name add primary_key(column_name);  #添加主键

```

#### 删除主键

```mysql
alter table table_name drop primary_key(column_name)
```

#### 添加其他索引

- 添加唯一索引

```mysql
alter table table_name add unique (column_name)
```



- 添加全文索引

```mysql
alter table table_name add fulltext(column_name)
```



- 添加普通索引

```mysql
alter table table_name add index(column_name)
```



#### 删除索引

```mysql
alter table table_name drop index column_name
```



#### 修改引擎

```mysql
alter table table_name engine=InnoDB  #修改索引
show engines  #查看所有的索引类型
show create table table_name  #  查看当前表的索引
```

#### 修改自增值

```mysql
alter table table_name  auto_increment=1
```





### 数据类型

> 数值、字符串、时间和日期

#### 数值类型

| 类型      | 大小                                     |
| --------- | ---------------------------------------- |
| tinyint   | 1字节                                    |
| smallint  | 2 字节                                   |
| mediumint | 3 字节                                   |
| int       | 4 字节                                   |
| bigint    | 8 字节                                   |
| float     | 4 字节                                   |
| double    | 8 字节                                   |
| decimal   | 对DECIMAL(M,D) ，如果M>D，为M+2否则为D+2 |

- zerofill:数值前面的位数是否需要用0填充
- 显示宽度：是否需要将数据类型对应的位数都用0显示出来
- 无符号：是否需要显示负数，unsigned

#### 字符串类型

| 类型       | 大小                | 用法                            |
| ---------- | ------------------- | ------------------------------- |
| char       | 0-255字节           | 定长字符串                      |
| varchar    | 0-65535字节         | 变长字符串                      |
| tinyblob   | 0-255字节           | 不超过255个字符串的二进制字符串 |
| tinytext   | 0-255字节           | 短文本字符串                    |
| blob       | 0-65535             | 二进制形式的长文本数据          |
| text       | 0-65535             | 长文本数据                      |
| mediumtext | 0-16 777 215字节    | 中等长度文本数据                |
| mediumblob | 0-16 777 215字节    | 二进制形式的中等长度文本数据    |
| LONGBLOB   | 0-4 294 967 295字节 | 二进制形式的极大文本数据        |
| LONGTEXT   | 0-4 294 967 295字节 | 极大文本数据                    |
| enum       | 0-65535             | 枚举                            |
| set        |                     | 集合                            |

#### 日期类型

| 类型      | 大小 | 格式                |
| --------- | ---- | ------------------- |
| date      | 3    | YYYY-MM-DD          |
| time      | 3    | HH:MM:SS            |
| year      | 1    | YYYY                |
| datetime  | 8    | YYYY-MM-DD HH:MM:SS |
| timestamp | 4    | YYYY-MM-DD HH:MM:SS |

### 引擎

#### MyISAM

- 不支持事务，不支持外键，访问速度快,每个MyISAM会生成3个文件，文件名跟表名相同，后缀分别为：
  - .frm(存储表定义) -->表结构信息
  - .MYD  存储数据
  - .MYI  存储索引

#### InnoDB

- 健壮的事务性存储引擎，以下情况用InnoDB合适：
  - 更新密集约束
  - 事务
  - 自动灾难恢复
  - 外键约束
  - 需要事务支持
- 生成文件后缀:
  - .frm
  - ibdata1
  - ibd

### 索引类型

#### 主键索引

- 一个表中只能是唯一的，在数据的查询，写入，读出能够按照一定的顺序，形成分组
- 主键的值不能重复，唯一的，auto_increment；

#### 唯一键 unique

- 可以给多个字段设置unique
- 在本字段不能出现相同的内容，null除外

#### 普通索引

- 一个表中能够给多个字段设置索引，查询时，形成一定的顺序，分组

#### 文本索引  fulltext

- 文本编辑器
- 能够帮助我们快速的在大批的文本中，有序查找内容

#### 外键

> 副表的非主键跟主表的主键关联    让两个表进行关联

##### 创建外键

```mysql
[CONSTRAINT constraint_name]                     #外键名
FOREIGN KEY [foreign_key_name]  (columns)       
REFERENCES parent_table(columns)
ON DELETE action (district(默认) | cascade(关联) | set null (将关联数据设置为null) | no action (什么也不做))
ON UPDATE action  (district(默认) | cascade(关联) | set null (将关联数据设置为null) | no action (什么也不做))
```

##### 删除外键

```mysql
#删除关联
alter table stu drop foreign key aaa;
#删除key
alter table stu drop key aaa;
```

##### 添加外键

```mysql
alter table stu add constraint aaa foreign key (cid) references classes (cid) on update set null on delete set null;
```

## DML:数据库操作语言 

> （Data Manipulation Language）数据库操作语言，insert,update,delete

### 插入

#### 单条插入

```mysql
insert into stu (sname,cid) values("李四","1")
```

#### 多条插入

```mysql
insert into stu (sname,cid) values("李四","1"),("李四","1"),("李四","1"),("李四","1")
```

#### 具有select字句的insert语句

```mysql
#拷贝表结构
create table aaa like stu
#拷贝表数据
insert into aaa select * from stu
```

#### ON DUPLICATE KEY UPDATE

> 因为primary,unique引发的错误会触发事件

#### replace语句 

> 如果要插入的信息指定了primary,unique，用replace插入已有的内容时，更新。
>
> 效率低

```mysql
replace into aaa (sname,cid) values("asd",3)
```

### update

```mysql
update [low_priority] [ingore]
```

low_priority    查询和更新同时进行时，保证先查询后更新

ignore  即使发生错误，后面的语句也可以执行

#### 具有select字句的update语句

```mysql
select tanme fom teach order by rand() limit 1;

update table_name set tname=(select tanme fom teach order by rand() limit 1) where tname id is null;

select tanme fom teach order by rand() limit 1;   #随机查询一条信息
```

#### 关联更新

- 第一种写法

```mysql
update kucun,dingdan 
set kucun.snum=kucun.snum-1,dingdan.dnum=dingdan.dnum+1 
where kucun.sid=1 and dingdan.dname='笔记本';
```

- 第二种写法

```mysql
update kucun join dingdan 
set kucun.snum=kucun.snum-1,dingdan.dnum=dingdan.dnum+1 
where kucun.sid=1 and dingdan.dname='笔记本';
```

### 删除语句

```mysql
delete from stu order by id desc limit 1;
```

#### 关联删除

```mysql
delete teach,stu from teach,stu where ……
```

#### 清空

```mysql
truncate stu;
```

### 日志管理

> 对服务器很重要，记录服务器的运行信息

- 错误日志：记录启动，运行，停止时出现的问题          ->开启

- 一般查询日志：记录建立客户端连接和执行的语句     ->一般不开
- 慢查询日志： 记录所有执行时间超过long_query_time的操作  ->开启
- 二进制日志：
- 中继日志
- 事务日志

#### 查询，修改mysql的全局变量

- 查询变量

```mysql
show global variables [like '%log%']
```

- 修改变量

```mysql
set global variabes_name=val
```

#### 错误日志

- 错误日志文件：log_error，指定mysqld保存错误日志文件的存放地址
- 启用警告信息：log_warnings

#### 一般查询日志

- 启动开关：general_log
- 日志文件变量:general_log_file
- 全局开关日志：log
- 记录类型：log_output

#### 慢查询

> mysql如果启用了slow_query_log选项，就会记录执行时间超过long_query_time的查询

- 查询超时时间：long_query_time
- 启动慢查询日志：log_slow_log=[on]
- 日志记录文件：slow_query_log_file

#### 事务日志

> 务性存储引擎用于保证（ACID）原子性，一致性，隔离性和持久性；不会立即写入到数据文件中，而是写到事务日志中

```mysql
innodb_flush
```

## DQL:数据查询语言 

>  (Data Query Langeage)   数据查询语言   select

```mysql
select 
column1,column2
from
table1
[inner | left | irght] join table2 on conditions
where
	conditions
group by column1
having grop_conditions
order by column1
limit offset length
```

别名

```mysql
select count(tname)  as num from teach
```

### 字句

#### where

##### 比较运算符

| 操作符 | 描述                              |
| ------ | --------------------------------- |
| =      | 几乎任何数据类型都可以使用        |
| <>或!= | 不等于                            |
| <      | 小于，通常使用数字，日期/时间类型 |
| >      | 大于                              |
| <=     | 小于等于                          |
| >=     | 大于等于                          |

##### 逻辑运算符

| 操作符 | 描述 |
| ------ | ---- |
| or     | 或者 |
| and    | 并且 |
| not    | 非   |

##### between

- 允许指定要测试的值的范围

```mysql
expr between aa and bb    # aa<=expr<=bb
```

- 获得指定的时间范围

```mysql
between cast('2013-01-01' as date) and cast('2014-01-01' as date)
```

##### like

```mysql
select * from where tname like "%老师"   #以“老师”结尾，前面任意
select * from where tname like "%老师%"   #中间是“老师”，前后任意
select * from where tname like "_老师_"   #中间是“老师”，前后任意一个字符
select * from where tname like "_老$师_" escape "$"   #用$做转义字符
```

查询内容中包含关键字，查询时用 “\”  转义  

##### in    

> 确定的字段

```mysql
select * from teach where birth in ("1990-10-01","1980-10-01")
```

##### find_in_set()函数

```mysql
find_in_set(needle,hay)   #needle  要查询的字符串     hay   要查询的字段
```

#### group by

```mysql
select c1,c2,...,aggregate_function(ci)
from
	table
where
	条件
group by c1,c2,...;
```

group by 必须出现在from  where字句之后；

##### having字句

> 是group by 后的筛选条件，分组后的数据组内再筛选

##### 聚集函数

- avg()   求平均数
- count()  计算表中的函数
- instr():返回子字符串在字符串中第一次出现的位置
- sum()  求和
- min()   求最小值
- max()  求最大值

#### order by

```mysql
select column1,column2
from  aaa
order by column1 [asc | desc],column2 [asc | desc] 
```

##### 自定义排序

```mysql
select * from goods order by field(gname,"绿茶","红茶","纯净水") [asc | desc]
```

#### limit

```mysql
select column1,column2
from aaa
limit offset,count    #  offset  偏移量   count  长度
```

### 关联查询

> 表与表之间有关系，通过关系去查询

- 交叉连接  cross join
- 内连接
- 左连接
- 右连接

#### 交叉连接(cross join)

> 笛卡尔积

#### 内连接（inner join）

> 交集

```mysql
select t1.id,t2.id from t1
inner join
t2 on 条件
```

#### 左连接

> 以左边为基准

```mysql
select t1.id,t2.id from t1
left join
t2 on 条件
```

#### 右连接

> 以右边为基准

```mysql
select t1.id,t2.id from t1
right join
t2 on 条件
```

### 联合查询

> 把多个select语句查询的结果合并起来

```mysql
select column_name from table1
union  [all]  #加上all，查询结果不会去重
select column_name from table2
```

- 列名为第一个查询的列名
- 会自动把重复项去掉
- 查询结果可以排序，分组，截取

### 子查询

- 标量子查询
- 列子查询
- 行子查询
- 表子查询

#### 标量子查询(取一个)

> 子查询返回的是单一值的标量

```mysql
select * from aaa where uid=(select uid from user where status=1 order by desc limit)
```

#### 列子查询

##### any 

> 可以与=,<,>,<=,>=结合起来使用，表示=,<,>,<=,>= 其中的任意一项

```mysql
select * from aaa where id< any(select id from bbb where id=2 or id=3)
```

##### all

> 可以与=,<,>,<=,>=结合起来使用，表示=,<,>,<=,>= 其中的每一项

```mysql
select * from aaa where id< all(select id from bbb where id=2 or id=3)
```

#### 行子查询

```mysql
select * from orders where (oname,cid)=(select ganme,cid from ganme="男装" and cid=1);
```

#### 表子查询

```mysql
select * from aaa where cty="杭州" and exists (select * from bbb where id=4ss)
```

### 常用函数

#### 聚合函数

> avg,count,sum,min,max;除count外，其他聚合函数在计算时会忽略null

##### count

```mysql
select count(*)  from aaa
```

##### avg

```mysql
select avg(price) as price from aaa
```

##### max

```mysql
select mix(price) from aaa
```

##### group_concat

```mysql
select group_concat(gname) from aaa group by cid
```

#### 字符串函数

##### concat()  

```mysql
select concat(column1,column2) from aaa  #把两个字符串连接起来
```

##### concat_ws()

```mysql
select concat_ws("_",column1,column2) from aaa  #把两个字符串用"-"连接起来
```

##### left()

> 返回具有指定长的字符串的左边部分

```mysql
select left("qweregtrnbgvfds",4)
#从第一位截取，长度为4
```

##### replace()

> 用新的字符串代替表的列中的字符串

```mysql
select replace(str,old_str,new_str)
```

##### substring()

> 从特定位置开始的字符串返回一个指定长度的字符串

```mysql
select substring("qwerthgbfvdcs",start,length)
```

##### trim()

```mysql
trim([{both|leading|trailing} [remove_str]] from str)
```

##### format()

```mysql
format(n,d,locale);   #n:数字  d:小数位数  

select FORMAT(1001.3535,2,"de_DE")
```

#### 时间日期函数

##### 返回当前日期函数

- curdate()

> 返回年月日

- now()

> 返回时间具体到秒,代表程序执行的时间

- sysdate()

> 返回时间具体到秒,代表当前的时间

##### 返回指定日期函数

- day()  获取日
- month()   获取月
- year()   获取年
- week（）获取第几周
- weekday()  获取星期几（0-6）
- dayname()   英文输出星期几                       set @@lc_time_names='zh_CN'  ---->中文输出星期几

##### 日期计算函数

- datediff

> 接受两个日期之间的差值 

- timediff()

> 计算两个time/datetime之间的差值

- timestampdiff(unit,begin,end)
  - microsecond  毫秒
  - second  秒
  - minute   分钟
  - quarter  季度

- date_add

> 将间隔时间添加到time/datetime

```mysql
date_add(start_date,interval expr unit)    # expr  数值    unit 单位
```

- date_sub

### 视图

> 对于复杂的查询，每一次的查询都会造成性能的消耗，维护是很麻烦的事，利用视图可以很好的解决

#### 创建视图

```mysql
create view viewname as select……
```

#### 修改视图

```mysql
alter view viewname as select……
```

##### create or replace view

```mysql
create on replace view viewname as select……
```

#### 删除视图

```mysql
drop view [if exists] viewname
```

#### 查看视图

```mysql
show create view view_name
```

### 临时表

> 适用于多表查询，且不常用;

#### 创建临时表

```mysql
create temporary table temp11 select ……
```

#### 删除临时表

```mysql

```



## TCL：事务控制语言  

>  (Transaction Controll Language)  事务控制语言

> 事务：数据库处理操作，其中执行就好像他是一个单一的一组有序的工作单元，如果事务中有任何操作失败，整个事务将失败

### 事务性质

- 原子性：确保了工作单位中的所有操作都成功完成，否则事务被终止，在失败时会回滚到事务操作以前的状态
- 一致性：可确保数据库在正确的更改状态在一个成功提交事务
- 隔离：使事务相互独立的操作
- 持久性：确保了提交事务的结果或系统故障情况下仍然存在作用

### 事务控制语句

- BEGING 或 START TRANSACTION:显式的开启一个事务
- COMMIT：也可以使用COMMIT WORK，不过二者是等价的COMMIT会提交事务，并使已对数据库进行的所有的修改成为永久性的
- ROLLBACK:有可以使用ROLLBACK WORK
- SET AUTOCOMMIT=0    禁止自动提交
- SET AUTOCOMMIT=1    开启自动提交

## 数据库锁

### 锁

> 锁是计算机协调多个进程或者线程并发访问某一资源的机制，数据库锁出现的原因是为了处理并发问题，因为数据库是一个多用户共享的资源，当出现并发的时候，就会导致出现各种各样奇怪的问题 

### MySQL锁概述

> 死锁：

- 表级锁：开销小，加锁快，不会出现死锁；锁定颗粒度大，发生锁冲突的概率最高，并发度最低
- 行级锁：开销大，加锁慢，会出现死锁；锁定颗粒度小，发生锁冲突的概率最低，并发度最高
- 页面锁：开锁和加锁时间介于表锁和行锁之间，会出现死锁，锁定颗粒度介于表锁和行锁之间，并发度一般

### 表级锁

> MyISAM引擎    MEMORY引擎支持表锁

#### 查看表锁的争用情况

```mysql
show status like "table%";
show status like "%lock%";
show processlist   #此命令可以查看那些sql在等待
show open tables   #当前被锁住的表以及锁的次数
```

##### 共享锁（读锁）

> 不会阻塞其他用户对表的读请求，但会阻塞随同一表的写请求;
>
> 可以查询锁定表中的记录，但更新和访问其他表会提示错误

##### 独占锁（写锁）

> 阻塞其他人对同一表的读和写的操作
>
> 可以读表中的记录，但更新和访问其他表会提示错误

> 级别： 写>读

#### 如何表加锁

> MyISAM执行查询语句前，会自动的给涉及的表加锁

##### 加锁

```mysql
#读锁
lock tables table_name read [local]
#写锁
lock tables table_name write [local]
```

##### 释放锁

```mysql
unlock tables
```

#### 并发插入

> myisam存储引擎有一个系统变量concurrent_insert，值分别为0，1，2

- 0( never):不允许并发插入  
- 1(auto)：如果miiasm表中没有空洞，myisam允许一个进程正读表的同时，另一个进程从表尾插入数据
- 2(always)：允许并发插入

#### 读写锁优先级(写>读)

- ##### 设置写锁的最多次数

> 有了这样的设置，当系统吃力一个写操作后，就会暂停写操作，给读操作执行的机会

```mysql
max_write_lock_count=1
```

- 降低写操作的优先级，给读操作更高的优先级

> 视情况而定

```mysql
low_priority_updates=1
```

#### 设置写内存

```mysql
max_allowed_packet=1M   #限制接受包大小，大的插入和更新会被限制掉，导致失败
net_buffer_length=2            #insert 语句的缓冲值   2k-16M
bulk_insert_buffer_size=8M         #一次性Insert语句的大小
```

#### 如何优化表锁

- concurrent_insert=2，总是允许并发插入
- optimize table
- 是否设置读写优先级
- 是否设置写内存

### 行锁

> 存储引擎：InnoDB

- 共享锁  S

> 允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁

- 排它锁  X

> 允许获得排它锁的事务更新数据，阻止其他事务获得相同的数据集的共享锁和排它锁

- 意向共享锁  IS

> 

- 意向排它锁   IX

| 兼容情况    0=冲突  1=兼容 | X    | IX   | S    | IS   |
| -------------------------- | ---- | ---- | ---- | ---- |
| X                          | 0    | 0    | 0    | 0    |
| IX                         | 0    | 1    | 0    | 1    |
| S                          | 0    | 0    | 1    | 1    |
| IS                         | 0    | 1    | 1    | 1    |

> 如果一个事务请求的锁模式与当前的锁兼容，innodb就将请求额锁授予该事务，反之，如果两者不兼容，该事务就要等待锁释放

#### 特点

- InnoDB实现行锁，当前字段必须有索引；否则，InnoDB将使用表锁
- 意向锁是InnoDB自动加，对于updat,insert,delete,InnoDB会自动给涉及的数据集添加排它锁，select，不会添加任何锁
- 在研究行锁，需要将自动提交关闭

```mysql
set autocommit=0   #多个客户端都要设置autocommit=0
```

#### 如何加行锁

##### 加锁

```mysql
共享锁：select * from table_name where ...LOCK IN SHARE MODE
排他锁：select * from table_name where ...FOR UPDATE
```

##### 释放

```mysql
commit;
rollback;
```

> 在InnoDB默认的隔离方式下，当我们给某一条数据上了排它锁，其他人不能操作该数据，但是可以操作其他数据；
>
> 在InnoDB默认的隔离方式下，当我们给某一条数据上了排它锁，其他人可以查询该数据，查询到的是旧值
>
> 如果正在操作数据的字段没有索引，行锁会自动升级为表锁；
>
> 即使字段加了索引，但是使用时字段类型转换，索引失效，行锁会自动升级为表锁；

##### 间隙锁

> 操作多条数据时，即使我们要操作的数据不在表中，但是在指定范围内，数据操作不了；

##### 查看行级锁争用情况

```mysql
show status like 'innodb_row_lock';
```

> current_waits   当前等待数量
>
> time   累加时间，用户等待锁
>
> time_avg    用户等待平均值
>
> time_max   等待时间最大值

### 事务并发的问题

1. 脏读：事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据就是脏数据
2. 不可重复读：事务A多次读取同一数据，事务B在事务A多次读取的过程中，对数据作了更改，导致事务A多次读取同一数据时，结果不一致
3. 幻读：

### 事务隔离级别

| 事务隔离级别              | 脏读 | 不可重复读 | 幻读 | 描述 |
| ------------------------- | ---- | ---------- | ---- | ---- |
| 读未提交 read uncommitted | 是   | 是         | 是   |      |
| 不可重复读 read committed | 否   | 是         | 是   |      |
| 可重复读                  | 否   | 否         | 是   |      |
| 串行化                    | 否   | 否         | 否   |      |

#### 查看隔离级别

```mysql
select @@session.tx_isolation;
```

#### 设置隔离级别

```mysql
ste session transaction isolation level read uncommitted
```

#### 如何优化行级锁

- 尽量使用较低级别的隔离级别：精心设计索引，并尽量使用索引访问数据，使加锁更加精确，从而减少锁冲突的机会
- 选择合理的事务大小：小事务发生冲突的几率小
- 给记录集显式加锁时，最好一次性请求足够级别的锁：比如要修改数据的话，最好直接申请排他锁，而不是先申请共享锁，再申请排它锁
- 尽量用相等条件访问数据，减少间隙锁对并发插入的影响
- 对于一些特定的事务，可以使用表锁来提高速度或减少死锁的可能

## 主从复制

> master服务器将数据的改变记录二进制日志，当master上的数据发生改变时，则将其改变写入二进制日志中；主库会生成一个 log dump 线程，用来给从库 i/o线程传binlog

### 主从复制配置过程

#### 基本要求

- 两台服务器
- 双方mysql版本一致，主节点低于从节点
- 关闭防火墙
- 数据库所用的用户，具有远程访问的权限

#### 修改主服务器的mysql的配置文件

```mysql
#mysql唯一id
server-id=1
#二进制日志文件，此项为必填项，否则不能同步数据；
log-bin="mysql-bin"
#指定二进制错误文件
log-error="mysql-error"
#需要同步的数据库，如果需要同步多个数据库：
binlog-do-db=demo
#binlog-do-db=slaveDB1
#binlog-do-db=slaveDB2
#不需要同步的数据库
binlog-ignore-db=mysql
```

#### 授权给从数据库服务器

```mysql
GRANT REPLICATION SLAVE ON *.* to 'root'@'111.111.111.111' identifided by '123456';
flush privileges;
```

#### 重启服务器

```mysql
service mysqld restart
```

#### 查看主服务器BIN日志的信息(执行完之后记录下这两个值)

```mysql
show master status;
```

#### 从服务器mysql配置文件

```mysql
server-id=2 #默认是1改成2
log-bin="mysql-bin" #这本身有
replicatioe-do-db=demo #需要同步的数据库
replicatioe-ignore-db=mysql #不需要同步的数据库
read_only #只读权限
```

#### 同步执行sql语句

```mysql
change master to
master_host='111.111.111.111', #设置要连接的主服务器IP地址
master_user='root', #设置要连接的主服务器用户名
master_password='123456', #设置要连接的主服务器密码
master_log_file='mysql-bin.000002', #设置要连接的主服务器bin日志的日志名称
master_log_pos=1041; #设置要连接的主服务器bin日志的记录位置
```

#### 启动slave同步进程

```mysql
#查看状态
show_slave status\G
#其中Slave_IO_Running Slave_SQL_Running值都是YES，表示状态正常
#如果之前从服务器启动过需要先停止在运行
stop slave
```



## 数据库优化



## MySQL操作

```mysql
#简单的数据库操作

show databases;   #查看数据库
create datebase  demo;   #创建名为demo的数据库
use demo;            #使用demo数据库
show tables;        #查看demo中的表
create table stu (
    id int(10) auto_increment primary key,   #表头名 数据类型  自增  主键
    name  varchar(10),
    age varchar(10),
    sex varchar(10))default charset=utf8;    #指定字符编码类型
desc stu;    #查看数据表的结构
insert into sut(name,age,sex) values("张三","20","男")   #插入数据
update stu set sex="女" where id=1;   #修改数据
delete from stu where id=1;    #删除数据
drop table stu     #删除表
drop database demo   #删除数据库
```

```mysql
# pymysql批量上传数据
cur.executemany("insert into phase(jname,jcon,kid) vaues(&s,%s,%s)",(1,2,3),(1,2,3))
```

 